<!DOCTYPE html>
 
<html>
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Анализ результатов взлома программы однокомандного процессора NORCPU</title>
   <link href="/favicon.png" rel="icon" />
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3017739-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" type="text/css" href="/css/highlight.css" />
   <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" />
   <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" /> 
   <link rel="alternate" title="Программирование - это просто!" href="/atom.xml" type="application/atom+xml">
</head>
<body>

<div class="site">

  <div class="menu">
    <a class="extra" href="/english">&laquo; english &raquo;</a>  
    <a href="/">блог</a> |
    <a href="/projects/">проекты</a> |
    <a href="/articles/">статьи</a> |
    <a href="/about/">автор</a>
  </div>

  <div id="home">
    <h1>Анализ результатов взлома программы однокомандного процессора NORCPU</h1>
<div id="post">
  <p>Итак, <a href="/blog/russian/2011/02/08/norcpu-hack-me-challenge/">публикуя анонс</a> <a href="/projects/norcpu/challenge/norcpu.html">задачи</a> по взлому программы, работающей на однокомандном процессоре NORCPU, я наивно думал, что хотя бы до конца марта я получу какое-нибудь решение.</p>

<p>Замечание: все цитируемые ниже фрагменты приводятся как есть, с минимальными правками в плане форматирования на странице.</p>

<p>В реальности все было иначе. Буквально через пару часов после <a href="http://habrahabr.ru/blogs/crazydev/113406/">поста на Хабре</a> пришло письмо от <strong>Vasiliy Artemev</strong>:</p>

<blockquote>
<p>Secret code: 139471</p>
</blockquote>

<p>Это было правильным ответом. Василий официально стал первым и получил законные 100$ призовых. Он любезно рассказал, что взломал методом грубой силы, перебором. Действительно, простейшая переборная атака заставляла программу выдать секретное слово уже на 3-х символьном пароле. Увы, моя реализация хеш-функции для пароля стала уязвимым звеном.</p>

<p>Но полного анализа не было, и к тому же Василий предложил спонсировать дальнейший анализ задачи в виде 50$ из начального призового фонда. В общем, анализ продолжался.</p>

<p>Тем временем я сделал <a href="/projects/norcpu/challenge/norcpu2.html">новую версию задачи</a>, где уже не было хеширования, а был просто зашифрованный пароль. Я думал, это усложнит взлом. Но вечером того же дня приходит письмо от <strong>Anton Bukov</strong>:</p>

<blockquote>
<p>Ответ на NORCPU hackme challenge, Version 2: &ldquo;R0und2 D0ne!&rdquo; ?</p>
</blockquote>

<p>Это правильный ответ. Я недоумевал. Как можно было так быстро разобраться?</p>

<p>Антон также любезно рассказал, как ему удалось получить ответ:</p>

<blockquote>
<p>Мой взлом основан на строке:</p>
</blockquote>

<pre class="hl">
mem <span class="hl opt">=</span> mem_0<span class="hl opt">.</span><span class="hl kwd">slice</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">);</span>
</pre>

<blockquote>
<p>Тут массив копируется, если дважды вызвать функцию calc на одном массиве, то для любого пароля будет отображен ответ. У меня в коде это выглядело так:</p>
</blockquote>

<pre class="hl">
wcout <span class="hl opt">&lt;&lt;</span> <span class="hl kwd">calc</span><span class="hl opt">(</span>L<span class="hl str">&quot;0&quot;</span><span class="hl opt">) &lt;&lt;</span> endl <span class="hl opt">&lt;&lt;</span> <span class="hl kwd">calc</span><span class="hl opt">(</span>L<span class="hl str">&quot;0&quot;</span><span class="hl opt">) &lt;&lt;</span> endl<span class="hl opt">;</span>
</pre>

<blockquote>
<p>Я так догадываюсь для предотвращения этого и осуществлялось копирование. Боюсь это не тот способ, которого вы ждали. Я и сам удивился, когда заметил ответ в output-е. Ну а после уже разобрался из-за чего он вылез.</p>
</blockquote>

<p>Антон случайно нашел баг, из-за которого программа опять сама выдавала секрет. Надо было запустить программу повторно без приведения памяти эмулятора в исходное состояния.</p>

<p>Корень проблемы:</p>

<pre class="hl">
...
  IS_0<span class="hl opt">(</span>flag<span class="hl opt">)</span>
  <span class="hl kwa">JZ</span> okay
  EXIT<span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">)</span>
<span class="hl kwc">okay:</span>
  <span class="hl slc">; print the secret</span>
...
</pre>

<p>После первого неправильного прогона и отказа в выводе секрета программа останавливалась в строке 4, и регистр комманд <code>ip</code> уже указывал на метку <code>okay</code>. Поэтому если интерпретатор просто запустить еще раз без инициализации памяти (а все регистры, включая <code>ip</code> находятся в памяти), он продолжит выполнение с метки <code>okay</code> и выведет секрет.</p>

<p>Досадно. Я быстро исправил проблему и выложил версию 2.1, в котором этого эффекта уже не было.</p>

<p>Прошло пару дней.</p>

<p>И вот приходит письмо от пользователя <strong>a5b</strong> с Хабра:</p>

<blockquote>
<p>Хотпатчинг переходов и ответ pw: <code>abcd</code> resp: <code>R0und2 D0ne!</code></p>

<ul>
<li>пароль естественно неверный</li>
<li>инвертировал записываемые данные в <code>(i == 27692 || i == 31712)</code></li>
</ul>
</blockquote>

<p>Формально, это решение, но нет пароля, а значит полного анализа тоже нет.</p>

<p>Но через час от <strong>a5b</strong> приходит довесок:</p>

<blockquote>
<pre><code>h1cKmE1fUsAn

input data:
chr conI LEET xor
CHR1 13417 13313 104 h
CHR2 39953 39968 49 1
CHR3 54302 54397 99 c
CHR4 32223 32148 75 K
CHR5 30900 30937 109 m
CHR6 27373 27304 69 E
CHR7 16420 16405 49 1
CHR8 49210 49244 102 f
CHR9 16740 16689 85 U
CHR10 50115 50096 115 s
CHR11 19308 19245 65 A
CHR12 57802 57764 110 n

static init:
CHRi 59609= 59651
CONi 59610= 59634
CNTR 59611=12
SUM 59608=0
LEET 59607 = 13313

1:
[59609]+1 -&gt; [59609] // select next chr
[59610]+1 -&gt; [59610] // select next con

SUM |= CHRi ^ LEET ^ CONi
LEET = LEET * 3 + 29

[59611]: if([59611] != 0) Loop 1

...
if(SUM != 0) exit
else print R0und2 D0ne // эту часть подробно не смотрел.
// Судя по модификациям кода (продвижение индекса), загружает 12 констант:
// 29528 22899 2971 9089 27542 17353 52278 25635 11626 34909 39131 51838,
// над каждой колдует и пишет в вывод
</code></pre>
</blockquote>

<p>А вот это уже анализ. <strong>a5b</strong> стал первым, кто прислал алгоритм <a href="/projects/norcpu/challenge/norcpu2.html">задачи номер 2</a>.</p>

<p>В тот же день вечером приходит письмо от <strong>Max Filippov</strong>:</p>

<blockquote>
<p>Algorithm that was used to check password correctness in the first round was the following:</p>
</blockquote>

<pre class="hl">
<span class="hl kwb">bool</span> <span class="hl kwd">check</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>p<span class="hl opt">)</span>
<span class="hl opt">{</span>
   <span class="hl kwb">int</span> v <span class="hl opt">=</span> <span class="hl num">0x1040</span><span class="hl opt">;</span>

   <span class="hl kwa">for</span><span class="hl opt">(; *</span>p<span class="hl opt">; ++</span>p<span class="hl opt">)</span>
   <span class="hl opt">{</span>
       v <span class="hl opt">^= *</span>p<span class="hl opt">;</span>
       <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">8</span><span class="hl opt">; ++</span>i<span class="hl opt">)</span>
       <span class="hl opt">{</span>
           <span class="hl kwb">int</span> f <span class="hl opt">=</span> v <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">;</span>
           v <span class="hl opt">&gt;&gt;=</span> <span class="hl num">1</span><span class="hl opt">;</span>
           <span class="hl kwa">if</span> <span class="hl opt">(</span>f<span class="hl opt">)</span>
               v <span class="hl opt">^=</span> <span class="hl num">0x1408</span><span class="hl opt">;</span>
       <span class="hl opt">}</span>
   <span class="hl opt">}</span>
   <span class="hl kwa">return</span> v <span class="hl opt">==</span> <span class="hl num">0x1c89</span><span class="hl opt">;</span>
<span class="hl opt">}</span>
</pre>

<blockquote>
<p>that is, sort of CRC.</p>

<p>To discover it I&rsquo;ve collected NORCPU execution trace and &ldquo;disassembled&rdquo; it.</p>

<p>Modified NORCPU source and disassembler are attached, and also may be found there: <a href="http://jcmvbkbc.spb.ru/git/?p=dumb/norcpu.git;a=summary">http://jcmvbkbc.spb.ru/git/?p=dumb/norcpu.git;a=summary</a></p>
</blockquote>

<p>И довесок:</p>

<blockquote>
<p>The method used is pretty straightforward:</p>

<ul>
<li>collect execution trace</li>
<li>recognize instruction patterns and collapse sequences of primitive instructions to more complex ones</li>
<li>analyze disassembled trace</li>
</ul>

<p>So, first I needed trace: I copied javascript text into cpp source, fixed lingual differences and inserted the following printf:</p>
</blockquote>

<pre class="hl">
<span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">) {</span>
  <span class="hl kwb">int</span> i <span class="hl opt">=</span> mem<span class="hl opt">[</span>ip<span class="hl opt">];</span>
  <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%04x:NOR(%04x, %04x =&gt; %04x) &quot;</span><span class="hl opt">,</span> i<span class="hl opt">,</span> mem<span class="hl opt">[</span>i<span class="hl opt">],</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">],</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">]);</span>
  <span class="hl kwb">int</span> a <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">];</span>
</pre>

<blockquote>
<p>so that I got a long line (about 8Mb) of primitive instruction execution trace.</p>

<p>Then I started constructing <code>sed</code> script that would make it readable.</p>

<p>First, it broke the trace line-wise, one instruction per line (288323 lines, will read it in case of insomnia). I took a look at processed trace and recorded several obvious instruction patterns into <code>sed</code>. Then reran script, took next look, recorded more patterns, &hellip;</p>

<p>This way I figured out all boolean logic commands and jumps. Then rotations left. Each time new command got recognized, new filtered processed trace was suggesting next step, e.g. 15 ROTL equals ROTR etc.</p>

<p>Then I looked into your article at &ldquo;<a href="/blog/russian/2010/03/26/one-command-cpu/">Модель процессора с одной командой</a>&rdquo;. And found addition pattern in disassembly. And recorded it in <code>sed</code> script.</p>

<p>After that I was able to just read the trace (which shrunk to 1035 lines). Its inner loop fit into one page, I just made some notes on a scratchpad:</p>

<pre><code>[f1ba]: current in-T index (i)
[f1b4]: LEN
[f1b5]: 8

0012-0035:[f1b9] ^= (T[i] &amp; 0xff)

006d-007b:[f1b8] = [f1b9] &amp; 1
008a-0158:[f1b9] &gt;&gt;= 1
0167-10c7:[f1aa] = [f1b8] + -1, [f1ab] = !carry
10ca-10e6:jmp on carry to 1145:110d

110d-111b:[f1b9] ^= 1408

1145-1f4f:--[f1b5]
20a5-3005:[f1aa] = [f1b5] + -1, f1ab = !carry
3008-3024:jmp on carry to 006d:304b

304b-304b:++i
3fab-3fab:--LEN
4f0b-5e8a:jmp on carry to 5eb1:6
</code></pre>

<p>then I browsed through the repetitions of this inner loop and found the end of the outer loop.</p>

<pre><code>5eb1-6e74:check 1c89
</code></pre>

<p>Then just translated it into C. It all took me three evenings.</p>
</blockquote>

<p>Затем от <strong>Max Filippov</strong> пришло решение и <a href="/projects/norcpu/challenge/norcpu2.html">второй задачи</a>.</p>

<blockquote>
<p>Ответ на второй тур &ndash; <code>h1cKmE1fUsAn</code></p>

<p>Результат &ndash; <code>R0und2 D0ne!</code></p>

<p>Алгоритм проверки пароля такой:</p>
</blockquote>

<pre class="hl">
<span class="hl kwb">bool</span> <span class="hl kwd">check</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>p<span class="hl opt">)</span>
<span class="hl opt">{</span>
   <span class="hl kwb">static const int</span> xor_array<span class="hl opt">[] = {</span>
       <span class="hl num">0x3469</span><span class="hl opt">,</span>
       <span class="hl num">0x9c11</span><span class="hl opt">,</span>
       <span class="hl num">0xd41e</span><span class="hl opt">,</span>
       <span class="hl num">0x7ddf</span><span class="hl opt">,</span>
       <span class="hl num">0x78b4</span><span class="hl opt">,</span>
       <span class="hl num">0x6aed</span><span class="hl opt">,</span>
       <span class="hl num">0x4024</span><span class="hl opt">,</span>
       <span class="hl num">0xc03a</span><span class="hl opt">,</span>
       <span class="hl num">0x4164</span><span class="hl opt">,</span>
       <span class="hl num">0xc3c3</span><span class="hl opt">,</span>
       <span class="hl num">0x4b6c</span><span class="hl opt">,</span>
       <span class="hl num">0xe1ca</span><span class="hl opt">,</span>
   <span class="hl opt">};</span>

   <span class="hl kwb">int</span> v <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
   <span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0x3401</span><span class="hl opt">;</span>

   <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">12</span><span class="hl opt">; ++</span>i<span class="hl opt">)</span>
   <span class="hl opt">{</span>
       <span class="hl kwb">int</span> f <span class="hl opt">=</span> p<span class="hl opt">[</span>i<span class="hl opt">] ^</span> x <span class="hl opt">^</span> xor_array<span class="hl opt">[</span>i<span class="hl opt">];</span>
       <span class="hl slc">// printf(&quot;x: %04x, f: %04x\n&quot;, x, f);</span>
       v <span class="hl opt">|=</span> f<span class="hl opt">;</span>
       x <span class="hl opt">= (</span>x <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">0x1d</span><span class="hl opt">) &amp;</span> <span class="hl num">0xffff</span><span class="hl opt">;</span>
   <span class="hl opt">}</span>
   <span class="hl kwa">return</span> <span class="hl opt">!</span>v<span class="hl opt">;</span>
<span class="hl opt">}</span>
</pre>

<blockquote>
<p>Закомментированный <code>printf</code> выводит ключевую фразу по ходу.</p>

<p>Методика анализа &ndash; как и в первом туре &ndash; дизассемблирование трассы выполнения.</p>

<p>Первый тур был откровенно интереснее.</p>
</blockquote>

<p>И, наконец, последнее полученное решение от <strong>Salo Kril</strong> для <a href="/projects/norcpu/challenge/norcpu.html">первой задачи</a>.</p>

<p>Особых пояснений нет &ndash; просто исходники.</p>

<pre class="hl">
<span class="hl slc">// Генерация паролей</span>

<span class="hl slc">// Brute_force(3);</span>

WORD <span class="hl kwd">ks_f</span><span class="hl opt">(</span><span class="hl kwb">char</span> <span class="hl opt">*</span>buff<span class="hl opt">,</span> <span class="hl kwb">int</span> len<span class="hl opt">)</span>
<span class="hl opt">{</span>
   <span class="hl kwb">int</span> i<span class="hl opt">,</span> j<span class="hl opt">;</span>
   WORD ks <span class="hl opt">=</span> <span class="hl num">0x1040</span><span class="hl opt">;</span>

   <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">;</span> i<span class="hl opt">++)</span>
   <span class="hl opt">{</span>
       ks <span class="hl opt">^=</span> buff<span class="hl opt">[</span>i<span class="hl opt">];</span>
       <span class="hl kwa">for</span> <span class="hl opt">(</span>j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> <span class="hl num">8</span><span class="hl opt">;</span> j<span class="hl opt">++)</span>
       <span class="hl opt">{</span>
           <span class="hl kwa">if</span><span class="hl opt">((</span>ks <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) ==</span> <span class="hl num">0</span><span class="hl opt">)</span>
               ks <span class="hl opt">=</span> ks <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">;</span>
           <span class="hl kwa">else</span>
               ks <span class="hl opt">= (</span>ks <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">) ^</span> <span class="hl num">0x1408</span><span class="hl opt">;</span>
       <span class="hl opt">}</span>
   <span class="hl opt">}</span>
   <span class="hl kwa">return</span> ks<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">Brute_force</span><span class="hl opt">(</span><span class="hl kwb">int</span> n<span class="hl opt">)</span>
<span class="hl opt">{</span>
   <span class="hl kwb">int</span> i<span class="hl opt">;</span>
   <span class="hl kwb">static char</span> alphabet<span class="hl opt">[] =</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F</span><span class="hl str">&quot;</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x3E\x3F</span><span class="hl str">&quot;</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4A\x4B\x4C\x4D\x4E\x4F</span><span class="hl str">&quot;</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5A\x5B\x5C\x5D\x5E\x5F</span><span class="hl str">&quot;</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6A\x6B\x6C\x6D\x6E\x6F</span><span class="hl str">&quot;</span>
       <span class="hl str">&quot;</span><span class="hl esc">\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7A\x7B\x7C\x7D\x7E</span><span class="hl str">&quot;</span><span class="hl opt">;</span>

   <span class="hl kwa">if</span><span class="hl opt">(</span>n <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
   <span class="hl opt">{</span>
       <span class="hl kwa">if</span><span class="hl opt">(</span><span class="hl kwd">ks_f</span><span class="hl opt">(</span>buff_bf<span class="hl opt">,</span> BF_N<span class="hl opt">) ==</span> <span class="hl num">0x1c89</span><span class="hl opt">)</span>
           <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span>buff_bf<span class="hl opt">);</span>
       <span class="hl kwa">return</span><span class="hl opt">;</span>
   <span class="hl opt">}</span>

   n<span class="hl opt">--;</span>
   <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> alphabet<span class="hl opt">[</span>i<span class="hl opt">];</span> i<span class="hl opt">++)</span>
   <span class="hl opt">{</span>
       buff_bf<span class="hl opt">[</span>n<span class="hl opt">] =</span> alphabet<span class="hl opt">[</span>i<span class="hl opt">];</span>
       <span class="hl kwd">Brute_force</span><span class="hl opt">(</span>n<span class="hl opt">);</span>
   <span class="hl opt">}</span>
<span class="hl opt">}</span>
</pre>

<p>и реконструированный код:</p>

<pre class="hl">
<span class="hl ppc">#define DEST_COUNT  0xF1FE</span>
<span class="hl kwc">extern</span> WORD mem<span class="hl opt">[];</span>

<span class="hl com">/*</span>
<span class="hl com">    Secret code: 139471</span>
<span class="hl com">*/</span>
<span class="hl kwb">void</span> <span class="hl kwd">reconstructed_fn</span><span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">int</span> i<span class="hl opt">,</span> j<span class="hl opt">;</span>
    WORD src<span class="hl opt">,</span> dest<span class="hl opt">,</span> key<span class="hl opt">,</span> count<span class="hl opt">,</span> hash<span class="hl opt">,</span> hash_OK<span class="hl opt">,</span> key_const<span class="hl opt">;</span>

    src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BA</span><span class="hl opt">];</span>     <span class="hl slc">// input string</span>
    count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1ED</span><span class="hl opt">];</span>   <span class="hl slc">// input string length</span>
    dest <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BB</span><span class="hl opt">];</span>    <span class="hl slc">// 0xf1ff</span>
    hash_OK <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BC</span><span class="hl opt">];</span> <span class="hl slc">// 0x1c89</span>
    hash <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1B9</span><span class="hl opt">];</span>    <span class="hl slc">// 0x1040</span>


    <span class="hl kwa">for</span><span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> count<span class="hl opt">;</span> i<span class="hl opt">++)</span>
    <span class="hl opt">{</span>
        hash <span class="hl opt">^=</span> mem<span class="hl opt">[</span>src <span class="hl opt">+</span> i<span class="hl opt">] &amp;</span> <span class="hl num">0xFF</span><span class="hl opt">;</span>

        <span class="hl kwa">for</span> <span class="hl opt">(</span>j <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> j <span class="hl opt">&lt;</span> <span class="hl num">8</span><span class="hl opt">;</span> j<span class="hl opt">++)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">if</span> <span class="hl opt">((</span>hash <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) ==</span> <span class="hl num">0</span><span class="hl opt">)</span>
                hash <span class="hl opt">=</span> hash <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">;</span>
            <span class="hl kwa">else</span>
                hash <span class="hl opt">= (</span>hash <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">) ^</span> <span class="hl num">0x1408</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>hash <span class="hl opt">==</span> hash_OK<span class="hl opt">)</span>
    <span class="hl opt">{</span>
        src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x6EB6</span><span class="hl opt">];</span>              <span class="hl slc">// &quot;Secret code: 139471&quot;</span>
        count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1C7</span><span class="hl opt">];</span>            <span class="hl slc">// 19</span>
        key <span class="hl opt">= ((</span>hash <span class="hl opt">&gt;&gt;</span> <span class="hl num">8</span><span class="hl opt">) ^</span> hash<span class="hl opt">) +</span> <span class="hl num">1</span><span class="hl opt">;</span>
        key_const <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x6EA8</span><span class="hl opt">];</span>        <span class="hl slc">// 11</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">else</span>
    <span class="hl opt">{</span>
        src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x5EBE</span><span class="hl opt">];</span>          <span class="hl slc">// &quot;Wrong password!&quot;</span>
        count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1DC</span><span class="hl opt">];</span>        <span class="hl slc">// 15</span>
        key <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BD</span><span class="hl opt">];</span>
        key_const <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BE</span><span class="hl opt">];</span>    <span class="hl slc">// 17</span>
    <span class="hl opt">}</span>

    mem<span class="hl opt">[</span>DEST_COUNT<span class="hl opt">] =</span> count<span class="hl opt">;</span>
    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> count<span class="hl opt">;</span> i<span class="hl opt">++)</span>
    <span class="hl opt">{</span>
        mem<span class="hl opt">[</span>dest <span class="hl opt">+</span> i<span class="hl opt">] =</span> mem<span class="hl opt">[</span>src <span class="hl opt">+</span> i<span class="hl opt">] ^</span> key<span class="hl opt">;</span>
        key <span class="hl opt">=</span> key <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> key_const<span class="hl opt">;</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="hl com">/*</span>
<span class="hl com">--------------------------------------------------------------------------------------------</span>
<span class="hl com">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="hl com">--------------------------------------------------------------------------------------------</span>
<span class="hl com">*/</span>
WORD <span class="hl kwa">and</span><span class="hl opt">(</span>WORD w1<span class="hl opt">,</span> WORD w2<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> w1 <span class="hl opt">&amp;</span> w2<span class="hl opt">;</span>
<span class="hl opt">}</span>

WORD <span class="hl kwa">or</span><span class="hl opt">(</span>WORD w1<span class="hl opt">,</span> WORD w2<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> w1 <span class="hl opt">|</span> w2<span class="hl opt">;</span>
<span class="hl opt">}</span>

WORD <span class="hl kwa">xor</span><span class="hl opt">(</span>WORD w1<span class="hl opt">,</span> WORD w2<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> w1 <span class="hl opt">^</span> w2<span class="hl opt">;</span>
<span class="hl opt">}</span>

WORD <span class="hl kwd">rol</span><span class="hl opt">(</span>WORD w1<span class="hl opt">,</span> WORD n<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span>w1 <span class="hl opt">&lt;&lt;</span> n<span class="hl opt">) | (</span>w1 <span class="hl opt">&gt;&gt; (</span><span class="hl num">16</span> <span class="hl opt">-</span> n<span class="hl opt">));</span>
<span class="hl opt">}</span>

WORD <span class="hl kwd">ror</span><span class="hl opt">(</span>WORD w1<span class="hl opt">,</span> WORD n<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">return</span> <span class="hl opt">(</span>w1 <span class="hl opt">&gt;&gt;</span> n<span class="hl opt">) | (</span>w1 <span class="hl opt">&lt;&lt; (</span><span class="hl num">16</span> <span class="hl opt">-</span> n<span class="hl opt">));</span>
<span class="hl opt">}</span>
WORD <span class="hl kwd">extend_16</span><span class="hl opt">(</span>WORD k1<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwb">int</span> i<span class="hl opt">,</span> k2<span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> k2 <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">16</span><span class="hl opt">;</span> i<span class="hl opt">++)</span>
    <span class="hl opt">{</span>
        k2 <span class="hl opt">=</span> <span class="hl kwa">or</span><span class="hl opt">(</span>k2<span class="hl opt">,</span> k1<span class="hl opt">);</span>
        k1 <span class="hl opt">=</span> <span class="hl kwd">rol</span><span class="hl opt">(</span>k1<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> k2<span class="hl opt">;</span>
<span class="hl opt">}</span>

WORD <span class="hl kwd">add</span><span class="hl opt">(</span>WORD <span class="hl opt">*</span>kk1<span class="hl opt">,</span> WORD a<span class="hl opt">,</span> WORD b<span class="hl opt">)</span>
<span class="hl opt">{</span>
    WORD mask_bit<span class="hl opt">,</span> aa0<span class="hl opt">,</span> aa1<span class="hl opt">,</span> tmp1<span class="hl opt">,</span> i<span class="hl opt">,</span> k1<span class="hl opt">,</span> k2<span class="hl opt">;</span>
    k1 <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    k2 <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
    mask_bit <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>

    <span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">16</span><span class="hl opt">;</span> i<span class="hl opt">++)</span>
    <span class="hl opt">{</span>
        k1 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>k1<span class="hl opt">,</span> mask_bit<span class="hl opt">);</span>
        aa0 <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">);</span>
        tmp1 <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>aa0<span class="hl opt">,</span> k1<span class="hl opt">);</span>
        tmp1 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>tmp1<span class="hl opt">,</span> mask_bit<span class="hl opt">);</span>
        k2 <span class="hl opt">=</span> <span class="hl kwa">or</span><span class="hl opt">(</span>tmp1<span class="hl opt">,</span> k2<span class="hl opt">);</span>
        aa1 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">);</span>
        aa0 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>k1<span class="hl opt">,</span> aa0<span class="hl opt">);</span>
        k1 <span class="hl opt">=</span> <span class="hl kwa">or</span><span class="hl opt">(</span>aa1<span class="hl opt">,</span> aa0<span class="hl opt">);</span>
        k1 <span class="hl opt">=</span> <span class="hl kwd">rol</span><span class="hl opt">(</span>k1<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
        mask_bit <span class="hl opt">=</span> <span class="hl kwd">rol</span><span class="hl opt">(</span>mask_bit<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>
    k1 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>k1<span class="hl opt">,</span> mask_bit<span class="hl opt">);</span>
    <span class="hl opt">*</span>kk1 <span class="hl opt">=</span> <span class="hl kwd">extend_16</span><span class="hl opt">(</span>k1<span class="hl opt">);</span>

    <span class="hl kwa">return</span> k2<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">reconstr</span><span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    WORD k1<span class="hl opt">,</span> k2<span class="hl opt">,</span> src<span class="hl opt">,</span> dest<span class="hl opt">,</span> tmp1<span class="hl opt">,</span> key<span class="hl opt">,</span> count<span class="hl opt">,</span> tmp2<span class="hl opt">,</span> tmp3<span class="hl opt">,</span> i<span class="hl opt">,</span> ks<span class="hl opt">,</span> ks_OK<span class="hl opt">,</span> key_a<span class="hl opt">;</span>
    WORD mask_bit<span class="hl opt">,</span> aa1<span class="hl opt">,</span> aa0<span class="hl opt">;</span>

    k1 <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1AF</span><span class="hl opt">];</span>    <span class="hl slc">// 0x88</span>
    k2 <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1A3</span><span class="hl opt">];</span>    <span class="hl slc">// 0x47</span>
    src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BA</span><span class="hl opt">];</span>   <span class="hl slc">// input string</span>
    count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1ED</span><span class="hl opt">];</span> <span class="hl slc">// input string length</span>
    dest <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BB</span><span class="hl opt">];</span>  <span class="hl slc">// 0xf1ff</span>
    ks_OK <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BC</span><span class="hl opt">];</span> <span class="hl slc">// 0x1c89             &quot;w&quot;:ks=0x0ACC   &quot;WWW&quot;:0x0FCE   &quot;123456789&quot;:ks=0x05E3</span>
    ks <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1B9</span><span class="hl opt">];</span>    <span class="hl slc">// 0x1040</span>


l_0006<span class="hl opt">:</span>
    ks <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> <span class="hl kwa">and</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>src<span class="hl opt">],</span> <span class="hl num">0xFF</span><span class="hl opt">));</span>
    i <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">;</span>

l_006D<span class="hl opt">:</span>
    tmp3 <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    ks <span class="hl opt">=</span> <span class="hl kwd">ror</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    ks <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> <span class="hl num">0x7FFF</span><span class="hl opt">);</span>
    tmp2 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k2<span class="hl opt">,</span> tmp3<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span>k2 <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span>
    <span class="hl opt">{</span>
        ks <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> <span class="hl num">0x1408</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

l_1145<span class="hl opt">:</span>
    i <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> i<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    tmp2 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k2<span class="hl opt">,</span> i<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span>k2 <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">goto</span> l_006D<span class="hl opt">;</span>

l_304B<span class="hl opt">:</span>
    src <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> src<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    count <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> count<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    tmp2 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k2<span class="hl opt">,</span> count<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span>k2 <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">goto</span> l_0006<span class="hl opt">;</span>


    src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x5EBE</span><span class="hl opt">];</span>    <span class="hl slc">// Wrong password!</span>
    count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1DC</span><span class="hl opt">];</span>  <span class="hl slc">// 15</span>
    key <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BD</span><span class="hl opt">];</span>
    key_a <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1BE</span><span class="hl opt">];</span>
    ks_OK <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>ks_OK<span class="hl opt">,</span> ks<span class="hl opt">);</span>
    tmp2 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k2<span class="hl opt">,</span> ks_OK<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>

    <span class="hl kwa">if</span><span class="hl opt">(</span>k2 <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">goto</span> l_8552<span class="hl opt">;</span>

l_6E9B<span class="hl opt">:</span>
    src <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x6EB6</span><span class="hl opt">];</span>     <span class="hl slc">// Secret code: 139471</span>
    count <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0xF1C7</span><span class="hl opt">];</span>   <span class="hl slc">// 19</span>
    key <span class="hl opt">=</span> ks<span class="hl opt">;</span>
    key_a <span class="hl opt">=</span> mem<span class="hl opt">[</span><span class="hl num">0x6EA8</span><span class="hl opt">];</span>

    key <span class="hl opt">=</span> <span class="hl kwd">ror</span><span class="hl opt">(</span>key<span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>key<span class="hl opt">,</span> <span class="hl num">0xFF</span><span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>ks<span class="hl opt">,</span> key<span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwa">and</span><span class="hl opt">(</span>key<span class="hl opt">,</span> <span class="hl num">0x7FFF</span><span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> key<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>


l_8552<span class="hl opt">:</span>
    mem<span class="hl opt">[</span>DEST_COUNT<span class="hl opt">] =</span> count<span class="hl opt">;</span>
l_8558<span class="hl opt">:</span>
    mem<span class="hl opt">[</span>dest<span class="hl opt">] =</span> <span class="hl kwa">xor</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>src<span class="hl opt">],</span> key<span class="hl opt">);</span>
    tmp3 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> key<span class="hl opt">,</span> key<span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> key<span class="hl opt">,</span> tmp3<span class="hl opt">);</span>
    key <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> key<span class="hl opt">,</span> key_a<span class="hl opt">);</span>
    src <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> src<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    dest <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> dest<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
    count <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k1<span class="hl opt">,</span> count<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    tmp2 <span class="hl opt">=</span> <span class="hl kwd">add</span><span class="hl opt">(&amp;</span>k2<span class="hl opt">,</span> count<span class="hl opt">, -</span><span class="hl num">1</span><span class="hl opt">);</span>
    <span class="hl kwa">if</span><span class="hl opt">(</span>k2 <span class="hl opt">!=</span> <span class="hl num">0</span><span class="hl opt">)</span>
        <span class="hl kwa">goto</span> l_8558<span class="hl opt">;</span>

l_F186<span class="hl opt">:</span>
    mem<span class="hl opt">[</span><span class="hl num">0xF1B2</span><span class="hl opt">] =</span> mem<span class="hl opt">[</span><span class="hl num">0xF193</span><span class="hl opt">];</span> <span class="hl slc">// nc</span>
<span class="hl opt">}</span>
</pre>

<p>Итак, как вы уже поняли, решения были полностью исчерпывающими.</p>

<p>Всем приславшим огромное спасибо за проявленное внимание.</p>

<p>Ниже привожу оригинальные исходники обоих задач. Надо просто запустить питоновский скрипт, он скомпилирует код, написанный через функции-макросы, сделает тестовый прогон и сгенерирует html-страничку (нужен файл-шаблон <code>template.html</code>).</p>

<p>Весь архив вместе c решениями-взломами доступны в виде <a href="https://github.com/begoon/norcpu/">git репозитория</a>.</p>

<h2>Задача 1</h2>

<p>Файл <a href="https://github.com/begoon/norcpu/blob/master/v1/norcpu.py">norcpu.py</a> (<a href="https://github.com/begoon/norcpu/blob/master/v1/template.html">template.html</a>):</p>

<pre class="hl">
<span class="hl kwa">import</span> sys<span class="hl opt">,</span> re<span class="hl opt">,</span> time<span class="hl opt">,</span> string<span class="hl opt">,</span> binascii

verbose <span class="hl opt">=</span> <span class="hl kwa">False</span>
verbose_cpu <span class="hl opt">=</span> <span class="hl kwa">False</span>
scramble <span class="hl opt">=</span> <span class="hl kwa">True</span>

test_wrong_crc <span class="hl opt">=</span> <span class="hl num">0</span>

secret_code <span class="hl opt">=</span> <span class="hl str">&quot;Secret code: 139471&quot;</span>
password <span class="hl opt">=</span> <span class="hl str">&quot;h0cKmE1fUsAn&quot;</span>
guess    <span class="hl opt">=</span> <span class="hl str">&quot;123456789012&quot;</span>
guess    <span class="hl opt">=</span> password

<span class="hl slc"># Secret code message encryption mask.</span>
secret_coef_add <span class="hl opt">=</span> <span class="hl num">17</span>

message_text <span class="hl opt">=</span> <span class="hl str">&quot;Wrong password!&quot;</span>
<span class="hl slc"># Wrong password message encryption mask.</span>
message_mask <span class="hl opt">=</span> <span class="hl num">0x6301</span>
message_coef_add <span class="hl opt">=</span> <span class="hl num">11</span>

<span class="hl slc"># Non-standard CRC initial value (should be 0xFFFF).</span>
crc16_initial_value <span class="hl opt">=</span> <span class="hl num">0x1040</span>

<span class="hl slc"># Non-standard CRC constant (should be 0x8401).</span>
crc16_constant <span class="hl opt">=</span> <span class="hl num">0x1408</span>

code_segment <span class="hl opt">= []</span>
data_segment <span class="hl opt">= []</span>

label_count <span class="hl opt">=</span> <span class="hl num">0</span>

<span class="hl kwa">def</span> <span class="hl kwd">dump</span><span class="hl opt">(</span>data<span class="hl opt">,</span> length <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">):</span>
  result <span class="hl opt">= []</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">xrange</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">),</span> length<span class="hl opt">):</span>
    line <span class="hl opt">=</span> data<span class="hl opt">[</span>i<span class="hl opt">:</span>i <span class="hl opt">+</span> length<span class="hl opt">]</span>
    hex_line <span class="hl opt">=</span> <span class="hl str">' '</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">([</span><span class="hl str">&quot;%04X&quot;</span> <span class="hl opt">%</span> x <span class="hl kwa">for</span> x <span class="hl kwa">in</span> line<span class="hl opt">])</span>
    result<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;%04X: %-*s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">% (</span>i<span class="hl opt">,</span> length<span class="hl opt">*</span><span class="hl num">5</span><span class="hl opt">,</span> hex_line<span class="hl opt">))</span>
  <span class="hl kwa">return</span> <span class="hl str">''</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>result<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">dump_js</span><span class="hl opt">(</span>data<span class="hl opt">,</span> length <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">):</span>
  result <span class="hl opt">= []</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">xrange</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">),</span> length<span class="hl opt">):</span>
    line <span class="hl opt">=</span> data<span class="hl opt">[</span>i<span class="hl opt">:</span>i <span class="hl opt">+</span> length<span class="hl opt">]</span>
    hex_line <span class="hl opt">=</span> <span class="hl str">' '</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">([</span><span class="hl str">&quot;0x%04X,&quot;</span> <span class="hl opt">%</span> x <span class="hl kwa">for</span> x <span class="hl kwa">in</span> line<span class="hl opt">])</span>
    result<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;%-*s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">% (</span>length<span class="hl opt">*</span><span class="hl num">5</span><span class="hl opt">,</span> hex_line<span class="hl opt">))</span>
  <span class="hl kwa">return</span> <span class="hl str">''</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>result<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">calc_crc16</span><span class="hl opt">(</span>data<span class="hl opt">):</span>
  <span class="hl kwa">global</span> crc16_initial_value
  <span class="hl kwa">global</span> crc16_constant

  crc16 <span class="hl opt">=</span> crc16_initial_value
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)):</span>
    ch <span class="hl opt">=</span> <span class="hl kwb">ord</span><span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">]) &amp;</span> <span class="hl num">0xff</span>
    crc16 <span class="hl opt">=</span> crc16 ^ ch
    <span class="hl kwa">for</span> j <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">):</span>
      <span class="hl kwa">if</span> <span class="hl opt">((</span>crc16 <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) !=</span> <span class="hl num">0</span><span class="hl opt">):</span>
        crc16 <span class="hl opt">= (</span>crc16 <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span><span class="hl opt">)</span> ^ crc16_constant
      <span class="hl kwa">else</span><span class="hl opt">:</span>
        crc16 <span class="hl opt">=</span> crc16 <span class="hl opt">&gt;&gt;</span> <span class="hl num">1</span>
  <span class="hl kwa">return</span> crc16

crc16 <span class="hl opt">=</span> <span class="hl kwd">calc_crc16</span><span class="hl opt">(</span>password<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">encode_string</span><span class="hl opt">(</span>data<span class="hl opt">,</span> name<span class="hl opt">,</span> mask<span class="hl opt">,</span> coef_add<span class="hl opt">):</span>
  <span class="hl kwa">global</span> mem<span class="hl opt">,</span> names
  offset <span class="hl opt">=</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  offset_sz <span class="hl opt">=</span> names<span class="hl opt">[</span>name <span class="hl opt">+</span> <span class="hl str">&quot;_sz&quot;</span><span class="hl opt">]</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)):</span>
    mem<span class="hl opt">[</span>offset <span class="hl opt">+</span> i<span class="hl opt">] =</span> <span class="hl kwb">ord</span><span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">])</span> ^ mask
    mask <span class="hl opt">= (</span>mask <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> coef_add<span class="hl opt">) &amp;</span> <span class="hl num">0xffff</span>
  mem<span class="hl opt">[</span>offset_sz<span class="hl opt">] =</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">put_string</span><span class="hl opt">(</span>data<span class="hl opt">,</span> name<span class="hl opt">):</span>
  <span class="hl kwa">global</span> mem<span class="hl opt">,</span> names
  offset <span class="hl opt">=</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  offset_sz <span class="hl opt">=</span> names<span class="hl opt">[</span>name <span class="hl opt">+</span> <span class="hl str">&quot;_sz&quot;</span><span class="hl opt">]</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)):</span>
    mem<span class="hl opt">[</span>offset <span class="hl opt">+</span> i<span class="hl opt">] =</span> <span class="hl kwb">ord</span><span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">])</span>
  mem<span class="hl opt">[</span>offset_sz<span class="hl opt">] =</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">save_mem</span><span class="hl opt">(</span>name<span class="hl opt">,</span> size <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  f <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span>name<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">if</span> size <span class="hl opt">== -</span><span class="hl num">1</span><span class="hl opt">:</span> size <span class="hl opt">=</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl opt">(</span>mem<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">:</span>size<span class="hl opt">]):</span>
    <span class="hl kwb">hex</span> <span class="hl opt">=</span> <span class="hl str">&quot;%04X&quot;</span> <span class="hl opt">%</span> i
    bin <span class="hl opt">=</span> binascii<span class="hl opt">.</span><span class="hl kwd">a2b_hex</span><span class="hl opt">(</span><span class="hl kwb">hex</span><span class="hl opt">)</span>
    f<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>bin<span class="hl opt">)</span>
  f<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>

<span class="hl kwa">def</span> <span class="hl kwd">next_label</span><span class="hl opt">():</span>
  <span class="hl kwa">global</span> label_count
  label_count <span class="hl opt">=</span> label_count <span class="hl opt">+</span> <span class="hl num">1</span>
  <span class="hl kwa">return</span> <span class="hl str">&quot;label_%04d&quot;</span> <span class="hl opt">%</span> label_count

<span class="hl kwa">def</span> <span class="hl kwd">code_rem</span><span class="hl opt">(</span>comment<span class="hl opt">):</span>
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">'; '</span> <span class="hl opt">+</span> comment<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">data_rem</span><span class="hl opt">(</span>comment<span class="hl opt">):</span>
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">'; '</span> <span class="hl opt">+</span> comment<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">data_label</span><span class="hl opt">(</span>name<span class="hl opt">):</span>
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>name <span class="hl opt">+</span> <span class="hl str">&quot;:&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">code_label</span><span class="hl opt">(</span>name<span class="hl opt">):</span>
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>name <span class="hl opt">+</span> <span class="hl str">&quot;:&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">code</span><span class="hl opt">(</span>value<span class="hl opt">):</span>
  printed <span class="hl opt">=</span> value
  <span class="hl kwa">if</span> <span class="hl kwb">type</span><span class="hl opt">(</span>value<span class="hl opt">).</span>__name__ <span class="hl opt">==</span> <span class="hl str">'int'</span><span class="hl opt">:</span>
    printed <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> value
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;  dw %s&quot;</span> <span class="hl opt">%</span> printed<span class="hl opt">)</span>

scramble_counter <span class="hl opt">=</span> <span class="hl num">0x27</span>

<span class="hl kwa">def</span> <span class="hl kwd">next_scramble_counter</span><span class="hl opt">():</span>
  <span class="hl kwa">global</span> scramble_counter
  scramble_counter <span class="hl opt">=</span> scramble_counter <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">7</span>
  <span class="hl kwa">return</span> scramble_counter <span class="hl opt">&amp;</span> <span class="hl num">0xff</span>

<span class="hl kwa">def</span> <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">):</span>
  <span class="hl kwa">if</span> value <span class="hl opt">== -</span><span class="hl num">1</span><span class="hl opt">:</span>
    <span class="hl kwa">if</span> scramble<span class="hl opt">:</span>
      value <span class="hl opt">=</span> <span class="hl kwd">next_scramble_counter</span><span class="hl opt">()</span>
    <span class="hl kwa">else</span><span class="hl opt">:</span>
      value <span class="hl opt">=</span> <span class="hl num">0</span>
  printed <span class="hl opt">=</span> value
  <span class="hl kwa">if</span> <span class="hl kwb">type</span><span class="hl opt">(</span>value<span class="hl opt">).</span>__name__ <span class="hl opt">==</span> <span class="hl str">'int'</span><span class="hl opt">:</span>
    printed <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> value
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;  dw %s&quot;</span> <span class="hl opt">%</span> printed<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwb">buffer</span><span class="hl opt">(</span>length<span class="hl opt">,</span> value <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> length<span class="hl opt">):</span>
    <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">var</span><span class="hl opt">(</span>name<span class="hl opt">,</span> value <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  <span class="hl kwd">data_label</span><span class="hl opt">(</span>name<span class="hl opt">);</span>
  <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">);</span>

<span class="hl kwa">def</span> <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'NOR '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>r<span class="hl opt">))</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>b<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>r<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">,</span> r<span class="hl opt">);</span>

<span class="hl kwa">def</span> <span class="hl kwd">OR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ANDi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">XORi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOV '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">))</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOV END'</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">JMP</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'JMP '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">JMPi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'JMPi '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">JMP</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>a<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOVi #'</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>imm<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  label_data <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  label_jump <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>label_data<span class="hl opt">,</span> a<span class="hl opt">)</span>
  <span class="hl kwd">JMPi</span><span class="hl opt">(</span>label_jump<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label_data<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>imm<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label_jump<span class="hl opt">)</span>

<span class="hl slc"># [a] -&gt; b</span>
<span class="hl kwa">def</span> <span class="hl kwd">PEEK</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  label1 <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  label2 <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label1<span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label2<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label1<span class="hl opt">)</span>  <span class="hl slc"># NOT(0, 0, move_reg)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- a</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label2<span class="hl opt">)</span>  <span class="hl slc">#</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- a</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc">#</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl slc"># a -&gt; [b]</span>
<span class="hl kwa">def</span> <span class="hl kwd">POKE</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'POKE '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' ['</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">) +</span> <span class="hl str">']'</span><span class="hl opt">)</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>b<span class="hl opt">,</span> label<span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># +3 (three operations)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># +4</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># +5</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- b</span>

<span class="hl slc"># imm -&gt; [a]</span>
<span class="hl kwa">def</span> <span class="hl kwd">POKEi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> a<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">POKE</span><span class="hl opt">(</span><span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">EXIT</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">EXITi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">FADD</span><span class="hl opt">(</span>mask<span class="hl opt">,</span> carry<span class="hl opt">,</span> a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_a&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># zero bits in 'a' except mask'ed</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_b&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># zero bits in 'b' except mask'ed</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> mask<span class="hl opt">,</span> carry<span class="hl opt">)</span>     <span class="hl slc"># zero bits in 'carry' except mask'ed</span>

  <span class="hl slc"># SUM = (a ^ b) ^ carry</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># Leave only 'mask'ed bit in bit_r.</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># Add current added bit to the result.</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">,</span> r<span class="hl opt">,</span> r<span class="hl opt">)</span>

  <span class="hl slc"># CARRY = (a &amp; b) | (carry &amp; (a ^ b))</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># CARRY is calculated, and 'shift_reg' contains the same value</span>
  <span class="hl slc"># but shifted the left by 1 bit.</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">)</span>

  <span class="hl slc"># CARRY is shifted the left by 1 bit to be used on the next round.</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">)</span>

  <span class="hl slc"># shift_reg = mask &lt;&lt; 1</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>mask<span class="hl opt">,</span> mask<span class="hl opt">)</span>
  <span class="hl slc"># mask = shift (effectively &quot;mask = mask &lt;&lt; 1&quot;)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> mask<span class="hl opt">)</span>

  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> mask<span class="hl opt">,</span> carry<span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_b&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ZERO</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">,</span> a<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">):</span>
    <span class="hl kwd">FADD</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>

  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>

  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">):</span>
    <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
    <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
    <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>

  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ADD</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ADDi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">PUSH</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">POKE</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>imm<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">PUSH</span><span class="hl opt">(</span><span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">POP</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">)</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">CALL</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">JMP</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">CALLi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">JMPi</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">RET</span><span class="hl opt">():</span>
  <span class="hl kwd">POP</span><span class="hl opt">(</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># Jump 'a', if cond = FFFF, and 'b' if conf = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">BRANCH</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> cond<span class="hl opt">):</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> cond<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">)</span>              <span class="hl slc"># reg_a = a &amp; cond</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>cond<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>                 <span class="hl slc"># reg_b = !cond</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># reg_b = b &amp; reg_b = b &amp; !cond</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># ip = (a &amp; cond) | (b &amp; !cond)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># Jump 'a', if cond = FFFF, and 'b' if conf = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> cond<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">BRANCH</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">,</span> cond<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># if a != 0 -&gt; carry = FFFF else carry = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">IS_0</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;is_0_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;is_0_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="hl kwa">def</span> <span class="hl kwd">JZi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label<span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl slc"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="hl kwa">def</span> <span class="hl kwd">JNZi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>label<span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ROL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">)</span>            <span class="hl slc"># shift_reg = a &lt;&lt; 1</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ROR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">15</span><span class="hl opt">):</span>
    <span class="hl kwd">ROL</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">SHL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">ROL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">ANDi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">0x0001</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">SHR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">ROR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">ANDi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">0x7FFF</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl slc"># NORCPU code</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;start&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl num">0xFFFF</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">code_label</span><span class="hl opt">(</span><span class="hl str">&quot;start&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;j&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> crc16_initial_value<span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;password&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;password_sz&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>

crc_loop <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>crc_loop<span class="hl opt">)</span>          <span class="hl slc"># crc_loop</span>
<span class="hl slc"># ch = *ptr</span>
<span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># ch &amp;= 0xFF</span>
<span class="hl kwd">ANDi</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl num">0xFF</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># crc16 ^= ch</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;crc16&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">,</span> <span class="hl str">&quot;j&quot;</span><span class="hl opt">)</span>
crc_loop_j <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>crc_loop_j<span class="hl opt">)</span>        <span class="hl slc"># crc_loop_j</span>

<span class="hl slc"># t = crc16 &amp; 1</span>
<span class="hl kwd">ANDi</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># crc16 &gt;&gt;= 1</span>
<span class="hl kwd">SHR</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;crc16&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>
crc_loop_1 <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">JZi</span><span class="hl opt">(</span>crc_loop_1<span class="hl opt">)</span>
<span class="hl slc"># crc16 ^= crc16_constant</span>
<span class="hl kwd">XORi</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> crc16_constant<span class="hl opt">,</span> <span class="hl str">&quot;crc16&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>crc_loop_1<span class="hl opt">)</span>        <span class="hl slc"># crc_loop_1</span>

<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;j&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;j&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;j&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>crc_loop_j<span class="hl opt">)</span>

<span class="hl slc"># ptr += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># i = i - 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>crc_loop<span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;result&quot;</span><span class="hl opt">)</span>

correct_crc <span class="hl opt">=</span> crc16 <span class="hl opt">+</span> test_wrong_crc

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;correct_crc&quot;</span><span class="hl opt">,</span> correct_crc<span class="hl opt">)</span>

<span class="hl slc"># By default we're going to decrypt 'Wrong...' message.</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;message&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;message_sz&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;message_mask&quot;</span><span class="hl opt">,</span> message_mask<span class="hl opt">)</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;message_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;coef_add&quot;</span><span class="hl opt">,</span> message_coef_add<span class="hl opt">)</span>

wrong_label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>

<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;correct_crc&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;correct_crc&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;correct_crc&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>wrong_label<span class="hl opt">)</span>

<span class="hl slc"># Now we switch to descrypt the secret message.</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span>secret_coef_add<span class="hl opt">,</span> <span class="hl str">&quot;coef_add&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;secret&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;secret_sz&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># mask = ((crc16 &amp; 0xff) | ((crc16 &gt;&gt; 8) &amp; 0xff)) + 1</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">8</span><span class="hl opt">):</span>
  <span class="hl kwd">SHR</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;crc16&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">ANDi</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl num">0xff</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">code_label</span><span class="hl opt">(</span>wrong_label<span class="hl opt">)</span>

<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;result_sz&quot;</span><span class="hl opt">)</span>

loop <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>loop<span class="hl opt">)</span>              <span class="hl slc"># loop</span>
<span class="hl slc"># ch = *ptr</span>
<span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># ch ^= mask</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">POKE</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># mask = mask * 3 + 11</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;coef_add&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;mask&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># ptr += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># ptr2 += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>
<span class="hl slc"># i = i - 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>loop<span class="hl opt">)</span>

<span class="hl kwd">EXITi</span><span class="hl opt">(</span><span class="hl num">0x00</span><span class="hl opt">)</span>

<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;stack&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;secret_sz&quot;</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>secret_code<span class="hl opt">))</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;secret&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl kwb">len</span><span class="hl opt">(</span>secret_code<span class="hl opt">) +</span> <span class="hl num">1</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;message_sz&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;message&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;password_sz&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;password&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">)</span>

<span class="hl slc"># The buffer holding the result string.</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;result_sz&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;result&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">32</span><span class="hl opt">)</span>

<span class="hl slc"># Compiler</span>

text <span class="hl opt">=</span> code_segment
text<span class="hl opt">.</span><span class="hl kwd">extend</span><span class="hl opt">(</span>data_segment<span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Phase 1. Calculate names.</span>

addr <span class="hl opt">=</span> <span class="hl num">0</span>
names <span class="hl opt">= {}</span>
<span class="hl kwa">for</span> line <span class="hl kwa">in</span> text<span class="hl opt">:</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">';'</span><span class="hl opt">:</span> <span class="hl kwa">continue</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] !=</span> <span class="hl str">' '</span><span class="hl opt">:</span>
    name <span class="hl opt">=</span> line<span class="hl opt">.</span><span class="hl kwd">partition</span><span class="hl opt">(</span><span class="hl str">':'</span><span class="hl opt">)[</span><span class="hl num">0</span><span class="hl opt">]</span>
    names<span class="hl opt">[</span>name<span class="hl opt">] =</span> addr
  <span class="hl kwa">else</span><span class="hl opt">:</span>
    addr <span class="hl opt">=</span> addr <span class="hl opt">+</span> <span class="hl num">1</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> names

raw_text <span class="hl opt">=</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Resolve names.</span>

<span class="hl kwa">for</span> name <span class="hl kwa">in</span> names<span class="hl opt">:</span>
  <span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
    <span class="hl kwa">print</span> name<span class="hl opt">,</span> names<span class="hl opt">[</span>name<span class="hl opt">],</span> <span class="hl kwb">type</span><span class="hl opt">(</span>names<span class="hl opt">[</span>name<span class="hl opt">])</span>
  name_re <span class="hl opt">=</span> re<span class="hl opt">.</span><span class="hl kwb">compile</span><span class="hl opt">(</span>r<span class="hl str">'dw '</span> <span class="hl opt">+</span> name <span class="hl opt">+</span> <span class="hl str">'$'</span><span class="hl opt">,</span> re<span class="hl opt">.</span>M<span class="hl opt">)</span>
  value <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  raw_text <span class="hl opt">=</span> name_re<span class="hl opt">.</span><span class="hl kwd">sub</span><span class="hl opt">(</span><span class="hl str">'dw '</span> <span class="hl opt">+</span> value<span class="hl opt">,</span> raw_text<span class="hl opt">)</span>

text <span class="hl opt">=</span> raw_text<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Phase 2. Compilation.</span>

addr <span class="hl opt">=</span> <span class="hl num">0</span>
comment <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
mem <span class="hl opt">= []</span>
<span class="hl kwa">for</span> line <span class="hl kwa">in</span> text<span class="hl opt">:</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">';'</span> <span class="hl kwa">or</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] !=</span> <span class="hl str">' '</span><span class="hl opt">:</span>
    comment <span class="hl opt">=</span> comment <span class="hl opt">+</span> line <span class="hl opt">+</span> <span class="hl str">' '</span>
  <span class="hl kwa">else</span><span class="hl opt">:</span>
    value <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>line<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">().</span><span class="hl kwd">partition</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">)[</span><span class="hl num">2</span><span class="hl opt">])</span>
    <span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
      <span class="hl kwa">print</span> <span class="hl str">&quot;%04X: %04X ; %s&quot;</span> <span class="hl opt">% (</span>addr<span class="hl opt">,</span> value<span class="hl opt">,</span> comment<span class="hl opt">)</span>
    mem<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>value<span class="hl opt">)</span>
    addr <span class="hl opt">=</span> addr <span class="hl opt">+</span> <span class="hl num">1</span>
    comment <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>

<span class="hl slc"># Interpretation</span>

ip <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">]</span>
exit_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">]</span>
shift_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">]</span>
carry_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">]</span>

<span class="hl kwa">def</span> <span class="hl kwd">nor</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  r <span class="hl opt">=</span> a | b
  r <span class="hl opt">=</span> r ^ <span class="hl num">0xFFFF</span>
  <span class="hl kwa">return</span> r <span class="hl opt">&amp;</span> <span class="hl num">0xFFFF</span>

<span class="hl kwa">def</span> <span class="hl kwd">norcpu</span><span class="hl opt">():</span>
  <span class="hl kwa">while</span> <span class="hl num">1</span><span class="hl opt">:</span>
    i <span class="hl opt">=</span> mem<span class="hl opt">[</span>ip<span class="hl opt">];</span>
    a <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">]</span>
    b <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">]</span>
    r <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">]</span>
    mem<span class="hl opt">[</span>ip<span class="hl opt">] =</span> i <span class="hl opt">+</span> <span class="hl num">3</span>
    f <span class="hl opt">=</span> <span class="hl kwd">nor</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>a<span class="hl opt">],</span> mem<span class="hl opt">[</span>b<span class="hl opt">])</span>
    mem<span class="hl opt">[</span>r<span class="hl opt">] =</span> f
    mem<span class="hl opt">[</span>shift_reg<span class="hl opt">] = ((</span>f <span class="hl opt">&gt;&gt;</span> <span class="hl num">15</span><span class="hl opt">) &amp;</span> <span class="hl num">1</span><span class="hl opt">)</span> | <span class="hl opt">((</span>f <span class="hl opt">&amp;</span> <span class="hl num">0x7FFF</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">1</span><span class="hl opt">)</span>

    <span class="hl kwa">if</span> verbose_cpu<span class="hl opt">:</span>
      <span class="hl kwa">print</span> <span class="hl str">&quot;%04X: %04X [%04X] %04X [%04X] -&gt; %04X [%04X]&quot;</span> <span class="hl opt">%</span> \
            <span class="hl opt">(</span>i<span class="hl opt">,</span> a<span class="hl opt">,</span> mem<span class="hl opt">[</span>a<span class="hl opt">],</span> b<span class="hl opt">,</span> mem<span class="hl opt">[</span>b<span class="hl opt">],</span> r<span class="hl opt">,</span> mem<span class="hl opt">[</span>r<span class="hl opt">])</span>
    <span class="hl kwa">if</span> r <span class="hl opt">==</span> exit_reg<span class="hl opt">:</span>
      <span class="hl kwa">break</span>

<span class="hl kwa">print</span> <span class="hl str">&quot;Starting from [%04X]&quot;</span> <span class="hl opt">%</span> mem<span class="hl opt">[</span>ip<span class="hl opt">]</span>

<span class="hl slc"># Encrypt the secret code.</span>
secret_mask <span class="hl opt">= ((</span>crc16 <span class="hl opt">&amp;</span> <span class="hl num">0xff</span><span class="hl opt">)</span> ^ <span class="hl opt">((</span>crc16 <span class="hl opt">&gt;&gt;</span> <span class="hl num">8</span><span class="hl opt">) &amp;</span> <span class="hl num">0xff</span><span class="hl opt">)) +</span> <span class="hl num">1</span>
<span class="hl kwd">encode_string</span><span class="hl opt">(</span>secret_code<span class="hl opt">,</span> <span class="hl str">&quot;secret&quot;</span><span class="hl opt">,</span> secret_mask<span class="hl opt">,</span> secret_coef_add<span class="hl opt">);</span>

<span class="hl slc"># Encrypt 'Wrong...' message.</span>
<span class="hl kwd">encode_string</span><span class="hl opt">(</span>message_text<span class="hl opt">,</span> <span class="hl str">&quot;message&quot;</span><span class="hl opt">,</span> message_mask<span class="hl opt">,</span> message_coef_add<span class="hl opt">);</span>

mem_js <span class="hl opt">=</span> <span class="hl kwd">dump_js</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-1-before.bin&quot;</span><span class="hl opt">)</span>
mem_sz <span class="hl opt">=</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

<span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">) &gt;=</span> <span class="hl num">0x10000</span><span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Too much code (%08X, %04X)&quot;</span> <span class="hl opt">% (</span><span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">),</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">) -</span> <span class="hl num">0x10000</span><span class="hl opt">)</span>
  sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">()</span>

<span class="hl slc"># Inject plain password in the last moment (for testing).</span>
<span class="hl kwd">put_string</span><span class="hl opt">(</span>guess<span class="hl opt">,</span> <span class="hl str">&quot;password&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-2-before-with-password.bin&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Original memory:&quot;</span>
  <span class="hl kwa">print</span> <span class="hl kwd">dump</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

start_time <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">()</span>

<span class="hl kwd">norcpu</span><span class="hl opt">()</span>

end_time <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">()</span>

<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-3-after.bin&quot;</span><span class="hl opt">,</span> mem_sz<span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Memory after:&quot;</span>
  <span class="hl kwd">dump</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

<span class="hl kwa">print</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Size: %X&quot;</span> <span class="hl opt">%</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Time: %d&quot;</span> <span class="hl opt">% (</span>end_time <span class="hl opt">-</span> start_time<span class="hl opt">)</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Exit: %04X&quot;</span> <span class="hl opt">%</span> mem<span class="hl opt">[</span>exit_reg<span class="hl opt">]</span>

<span class="hl kwa">print</span><span class="hl opt">(</span><span class="hl str">&quot;CRC : %04X (%04X)&quot;</span> <span class="hl opt">% (</span>crc16<span class="hl opt">,</span> correct_crc<span class="hl opt">))</span>

result <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;result&quot;</span><span class="hl opt">]</span>
result_value <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
<span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> mem<span class="hl opt">[</span>names<span class="hl opt">[</span><span class="hl str">&quot;result_sz&quot;</span><span class="hl opt">]]):</span>
  result_value <span class="hl opt">=</span> result_value <span class="hl opt">+</span> <span class="hl kwb">chr</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>result <span class="hl opt">+</span> i<span class="hl opt">] &amp;</span> <span class="hl num">0xff</span><span class="hl opt">)</span>

<span class="hl kwa">if</span> result_value <span class="hl opt">!=</span> secret_code<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;ERROR: [%s] != [%s]&quot;</span> <span class="hl opt">% (</span>secret_code<span class="hl opt">,</span> result_value<span class="hl opt">)</span>

js <span class="hl opt">=</span> string<span class="hl opt">.</span><span class="hl kwd">Template</span><span class="hl opt">(</span><span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">'template.html'</span><span class="hl opt">,</span> <span class="hl str">'r'</span><span class="hl opt">).</span><span class="hl kwd">read</span><span class="hl opt">())</span>

js <span class="hl opt">=</span> js<span class="hl opt">.</span><span class="hl kwd">substitute</span><span class="hl opt">(</span> \
  ip <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">],</span>
  exit_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">],</span>
  shift_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">],</span>
  password <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;password&quot;</span><span class="hl opt">],</span>
  password_sz <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;password_sz&quot;</span><span class="hl opt">],</span>
  result <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;result&quot;</span><span class="hl opt">],</span>
  result_sz <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;result_sz&quot;</span><span class="hl opt">],</span>
  mem_js <span class="hl opt">=</span> mem_js
<span class="hl opt">)</span>

f <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu.html&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">)</span>
f<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>js<span class="hl opt">)</span>
f<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>
</pre>

<h2>Задача 2</h2>

<p>Файл <a href="https://github.com/begoon/norcpu/blob/master/v2/norcpu.py">norcpu.py</a> (<a href="https://github.com/begoon/norcpu/blob/master/v2/template.html">template.html</a>).</p>

<pre class="hl">
<span class="hl kwa">import</span> sys<span class="hl opt">,</span> re<span class="hl opt">,</span> time<span class="hl opt">,</span> string<span class="hl opt">,</span> binascii

verbose <span class="hl opt">=</span> <span class="hl kwa">False</span>
verbose_cpu <span class="hl opt">=</span> <span class="hl kwa">False</span>
scramble <span class="hl opt">=</span> <span class="hl kwa">True</span>

secret_password <span class="hl opt">=</span> <span class="hl str">&quot;h1cKmE1fUsAn&quot;</span>
secret_password_xor_mask <span class="hl opt">=</span> <span class="hl num">0x3401</span>
secret_password_add <span class="hl opt">=</span> <span class="hl num">29</span>

secret_code <span class="hl opt">=</span> <span class="hl str">&quot;R0und2 D0ne!&quot;</span>
secret_code_xor_mask <span class="hl opt">=</span> <span class="hl num">0x730A</span>
secret_code_add <span class="hl opt">=</span> <span class="hl num">37</span>

guess <span class="hl opt">=</span> <span class="hl str">&quot;123456789012&quot;</span>
guess <span class="hl opt">=</span> secret_password

code_segment <span class="hl opt">= []</span>
data_segment <span class="hl opt">= []</span>

label_count <span class="hl opt">=</span> <span class="hl num">0</span>

<span class="hl kwa">def</span> <span class="hl kwd">dump</span><span class="hl opt">(</span>data<span class="hl opt">,</span> length <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">):</span>
  result <span class="hl opt">= []</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">xrange</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">),</span> length<span class="hl opt">):</span>
    line <span class="hl opt">=</span> data<span class="hl opt">[</span>i<span class="hl opt">:</span>i <span class="hl opt">+</span> length<span class="hl opt">]</span>
    hex_line <span class="hl opt">=</span> <span class="hl str">' '</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">([</span><span class="hl str">&quot;%04X&quot;</span> <span class="hl opt">%</span> x <span class="hl kwa">for</span> x <span class="hl kwa">in</span> line<span class="hl opt">])</span>
    result<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;%04X: %-*s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">% (</span>i<span class="hl opt">,</span> length<span class="hl opt">*</span><span class="hl num">5</span><span class="hl opt">,</span> hex_line<span class="hl opt">))</span>
  <span class="hl kwa">return</span> <span class="hl str">''</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>result<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">dump_js</span><span class="hl opt">(</span>data<span class="hl opt">,</span> length <span class="hl opt">=</span> <span class="hl num">8</span><span class="hl opt">):</span>
  result <span class="hl opt">= []</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">xrange</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">),</span> length<span class="hl opt">):</span>
    line <span class="hl opt">=</span> data<span class="hl opt">[</span>i<span class="hl opt">:</span>i <span class="hl opt">+</span> length<span class="hl opt">]</span>
    hex_line <span class="hl opt">=</span> <span class="hl str">' '</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">([</span><span class="hl str">&quot;0x%04X,&quot;</span> <span class="hl opt">%</span> x <span class="hl kwa">for</span> x <span class="hl kwa">in</span> line<span class="hl opt">])</span>
    result<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;%-*s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> <span class="hl opt">% (</span>length<span class="hl opt">*</span><span class="hl num">5</span><span class="hl opt">,</span> hex_line<span class="hl opt">))</span>
  <span class="hl kwa">return</span> <span class="hl str">''</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>result<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">encode_string</span><span class="hl opt">(</span>data<span class="hl opt">,</span> name<span class="hl opt">,</span> mask<span class="hl opt">,</span> coef_add<span class="hl opt">):</span>
  <span class="hl kwa">global</span> mem<span class="hl opt">,</span> names
  offset <span class="hl opt">=</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  offset_sz <span class="hl opt">=</span> names<span class="hl opt">[</span>name <span class="hl opt">+</span> <span class="hl str">&quot;_sz&quot;</span><span class="hl opt">]</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)):</span>
    mem<span class="hl opt">[</span>offset <span class="hl opt">+</span> i<span class="hl opt">] =</span> <span class="hl kwb">ord</span><span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">])</span> ^ mask
    mask <span class="hl opt">= (</span>mask <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> coef_add<span class="hl opt">) &amp;</span> <span class="hl num">0xffff</span>
  mem<span class="hl opt">[</span>offset_sz<span class="hl opt">] =</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">put_string</span><span class="hl opt">(</span>data<span class="hl opt">,</span> name<span class="hl opt">):</span>
  <span class="hl kwa">global</span> mem<span class="hl opt">,</span> names
  offset <span class="hl opt">=</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  offset_sz <span class="hl opt">=</span> names<span class="hl opt">[</span>name <span class="hl opt">+</span> <span class="hl str">&quot;_sz&quot;</span><span class="hl opt">]</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)):</span>
    mem<span class="hl opt">[</span>offset <span class="hl opt">+</span> i<span class="hl opt">] =</span> <span class="hl kwb">ord</span><span class="hl opt">(</span>data<span class="hl opt">[</span>i<span class="hl opt">])</span>
  mem<span class="hl opt">[</span>offset_sz<span class="hl opt">] =</span> <span class="hl kwb">len</span><span class="hl opt">(</span>data<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">save_mem</span><span class="hl opt">(</span>name<span class="hl opt">,</span> size <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  f <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span>name<span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">if</span> size <span class="hl opt">== -</span><span class="hl num">1</span><span class="hl opt">:</span> size <span class="hl opt">=</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl opt">(</span>mem<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">:</span>size<span class="hl opt">]):</span>
    <span class="hl kwb">hex</span> <span class="hl opt">=</span> <span class="hl str">&quot;%04X&quot;</span> <span class="hl opt">%</span> i
    bin <span class="hl opt">=</span> binascii<span class="hl opt">.</span><span class="hl kwd">a2b_hex</span><span class="hl opt">(</span><span class="hl kwb">hex</span><span class="hl opt">)</span>
    f<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>bin<span class="hl opt">)</span>
  f<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>

<span class="hl kwa">def</span> <span class="hl kwd">next_label</span><span class="hl opt">():</span>
  <span class="hl kwa">global</span> label_count
  label_count <span class="hl opt">=</span> label_count <span class="hl opt">+</span> <span class="hl num">1</span>
  <span class="hl kwa">return</span> <span class="hl str">&quot;label_%04d&quot;</span> <span class="hl opt">%</span> label_count

<span class="hl kwa">def</span> <span class="hl kwd">code_rem</span><span class="hl opt">(</span>comment<span class="hl opt">):</span>
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">'; '</span> <span class="hl opt">+</span> comment<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">data_rem</span><span class="hl opt">(</span>comment<span class="hl opt">):</span>
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">'; '</span> <span class="hl opt">+</span> comment<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">data_label</span><span class="hl opt">(</span>name<span class="hl opt">):</span>
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>name <span class="hl opt">+</span> <span class="hl str">&quot;:&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">code_label</span><span class="hl opt">(</span>name<span class="hl opt">):</span>
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>name <span class="hl opt">+</span> <span class="hl str">&quot;:&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">code</span><span class="hl opt">(</span>value<span class="hl opt">):</span>
  printed <span class="hl opt">=</span> value
  <span class="hl kwa">if</span> <span class="hl kwb">type</span><span class="hl opt">(</span>value<span class="hl opt">).</span>__name__ <span class="hl opt">==</span> <span class="hl str">'int'</span><span class="hl opt">:</span>
    printed <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> value
  code_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;  dw %s&quot;</span> <span class="hl opt">%</span> printed<span class="hl opt">)</span>

scramble_counter <span class="hl opt">=</span> <span class="hl num">0x2743</span>

<span class="hl kwa">def</span> <span class="hl kwd">next_scramble_counter</span><span class="hl opt">():</span>
  <span class="hl kwa">global</span> scramble_counter
  scramble_counter <span class="hl opt">=</span> scramble_counter <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">7</span>
  <span class="hl kwa">return</span> scramble_counter <span class="hl opt">&amp;</span> <span class="hl num">0xffff</span>

<span class="hl kwa">def</span> <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">):</span>
  <span class="hl kwa">if</span> value <span class="hl opt">== -</span><span class="hl num">1</span><span class="hl opt">:</span>
    <span class="hl kwa">if</span> scramble<span class="hl opt">:</span>
      value <span class="hl opt">=</span> <span class="hl kwd">next_scramble_counter</span><span class="hl opt">()</span>
    <span class="hl kwa">else</span><span class="hl opt">:</span>
      value <span class="hl opt">=</span> <span class="hl num">0</span>
  printed <span class="hl opt">=</span> value
  <span class="hl kwa">if</span> <span class="hl kwb">type</span><span class="hl opt">(</span>value<span class="hl opt">).</span>__name__ <span class="hl opt">==</span> <span class="hl str">'int'</span><span class="hl opt">:</span>
    printed <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> value
  data_segment<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span><span class="hl str">&quot;  dw %s&quot;</span> <span class="hl opt">%</span> printed<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwb">buffer</span><span class="hl opt">(</span>length<span class="hl opt">,</span> value <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> length<span class="hl opt">):</span>
    <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">var</span><span class="hl opt">(</span>name<span class="hl opt">,</span> value <span class="hl opt">= -</span><span class="hl num">1</span><span class="hl opt">):</span>
  <span class="hl kwd">data_label</span><span class="hl opt">(</span>name<span class="hl opt">);</span>
  <span class="hl kwd">word</span><span class="hl opt">(</span>value<span class="hl opt">);</span>

<span class="hl slc"># Macros</span>

<span class="hl kwa">def</span> <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'NOR '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>r<span class="hl opt">))</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>b<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>r<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">,</span> r<span class="hl opt">);</span>

<span class="hl kwa">def</span> <span class="hl kwd">OR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;or_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ANDi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;and_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">XORi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOV '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">))</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOV END'</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">JMP</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'JMP '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">JMPi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'JMPi '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">JMP</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>a<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> a<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'MOVi #'</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>imm<span class="hl opt">) +</span> <span class="hl str">' '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">))</span>
  label_data <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  label_jump <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>label_data<span class="hl opt">,</span> a<span class="hl opt">)</span>
  <span class="hl kwd">JMPi</span><span class="hl opt">(</span>label_jump<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label_data<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span>imm<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label_jump<span class="hl opt">)</span>

<span class="hl slc"># [a] -&gt; b</span>
<span class="hl kwa">def</span> <span class="hl kwd">PEEK</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  label1 <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  label2 <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label1<span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label2<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label1<span class="hl opt">)</span>  <span class="hl slc"># NOT(0, 0, move_reg)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- a</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label2<span class="hl opt">)</span>  <span class="hl slc">#</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- a</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc">#</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl slc"># a -&gt; [b]</span>
<span class="hl kwa">def</span> <span class="hl kwd">POKE</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">code_rem</span><span class="hl opt">(</span><span class="hl str">'POKE '</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>a<span class="hl opt">) +</span> <span class="hl str">' ['</span> <span class="hl opt">+</span> <span class="hl kwb">str</span><span class="hl opt">(</span>b<span class="hl opt">) +</span> <span class="hl str">']'</span><span class="hl opt">)</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>b<span class="hl opt">,</span> label<span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># +3 (three operations)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># +4</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl str">&quot;move_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># +5</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">)</span>             <span class="hl slc"># &lt;- b</span>

<span class="hl slc"># imm -&gt; [a]</span>
<span class="hl kwa">def</span> <span class="hl kwd">POKEi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> a<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">POKE</span><span class="hl opt">(</span><span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;poke_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">EXIT</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">EXITi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">FADD</span><span class="hl opt">(</span>mask<span class="hl opt">,</span> carry<span class="hl opt">,</span> a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_a&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># zero bits in 'a' except mask'ed</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_b&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># zero bits in 'b' except mask'ed</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> mask<span class="hl opt">,</span> carry<span class="hl opt">)</span>     <span class="hl slc"># zero bits in 'carry' except mask'ed</span>

  <span class="hl slc"># SUM = (a ^ b) ^ carry</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># Leave only 'mask'ed bit in bit_r.</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">,</span> mask<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># Add current added bit to the result.</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">,</span> r<span class="hl opt">,</span> r<span class="hl opt">)</span>

  <span class="hl slc"># CARRY = (a &amp; b) | (carry &amp; (a ^ b))</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>

  <span class="hl slc"># CARRY is calculated, and 'shift_reg' contains the same value</span>
  <span class="hl slc"># but shifted the left by 1 bit.</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">)</span>

  <span class="hl slc"># CARRY is shifted the left by 1 bit to be used on the next round.</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> carry<span class="hl opt">)</span>

  <span class="hl slc"># shift_reg = mask &lt;&lt; 1</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>mask<span class="hl opt">,</span> mask<span class="hl opt">)</span>
  <span class="hl slc"># mask = shift (effectively &quot;mask = mask &lt;&lt; 1&quot;)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> mask<span class="hl opt">)</span>

  <span class="hl kwd">AND</span><span class="hl opt">(</span>carry<span class="hl opt">,</span> mask<span class="hl opt">,</span> carry<span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_b&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_bit_r&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t1&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadd_reg_t2&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ZERO</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">XOR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">,</span> a<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">):</span>
    <span class="hl kwd">FADD</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>

  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>

  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">):</span>
    <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>
    <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
    <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>

  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;fadc_reg_t&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ADD</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> r<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ADDi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> imm<span class="hl opt">,</span> r<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">,</span> r<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;add_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">PUSH</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">POKE</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>imm<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>imm<span class="hl opt">,</span> <span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">PUSH</span><span class="hl opt">(</span><span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;push_i_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">POP</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">)</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">CALL</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">JMP</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">CALLi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">PUSHi</span><span class="hl opt">(</span>label<span class="hl opt">)</span>
  <span class="hl kwd">JMPi</span><span class="hl opt">(</span>a<span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">RET</span><span class="hl opt">():</span>
  <span class="hl kwd">POP</span><span class="hl opt">(</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># Jump 'a', if cond = FFFF, and 'b' if conf = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">BRANCH</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> cond<span class="hl opt">):</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>a<span class="hl opt">,</span> cond<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">)</span>              <span class="hl slc"># reg_a = a &amp; cond</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span>cond<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>                 <span class="hl slc"># reg_b = !cond</span>
  <span class="hl kwd">AND</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># reg_b = b &amp; reg_b = b &amp; !cond</span>
  <span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ip&quot;</span><span class="hl opt">)</span>  <span class="hl slc"># ip = (a &amp; cond) | (b &amp; !cond)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># Jump 'a', if cond = FFFF, and 'b' if conf = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">,</span> cond<span class="hl opt">):</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOVi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">BRANCH</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">,</span> cond<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_a&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;branch_i_reg_b&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># if a != 0 -&gt; carry = FFFF else carry = 0000</span>
<span class="hl kwa">def</span> <span class="hl kwd">IS_0</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  <span class="hl kwd">ZERO</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">FADC</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;is_0_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">NOT</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;is_0_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="hl kwa">def</span> <span class="hl kwd">JZi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>a<span class="hl opt">,</span> label<span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl slc"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="hl kwa">def</span> <span class="hl kwd">JNZi</span><span class="hl opt">(</span>a<span class="hl opt">):</span>
  label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
  <span class="hl kwd">BRANCHi</span><span class="hl opt">(</span>label<span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl str">&quot;zero_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">code_label</span><span class="hl opt">(</span>label<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ROL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">)</span>            <span class="hl slc"># shift_reg = a &lt;&lt; 1</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">ROR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl num">15</span><span class="hl opt">):</span>
    <span class="hl kwd">ROL</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>
  <span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">,</span> b<span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ror_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">SHL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">ROL</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">ANDi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">0x0001</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">SHR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">ROR</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">)</span>
  <span class="hl kwd">ANDi</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">0x7FFF</span><span class="hl opt">,</span> b<span class="hl opt">)</span>

<span class="hl kwa">def</span> <span class="hl kwd">MUL3</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span>a<span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl str">&quot;mul3_reg&quot;</span><span class="hl opt">)</span>    <span class="hl slc"># mul3_reg = a + a</span>
  <span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;mul3_reg&quot;</span><span class="hl opt">,</span> a<span class="hl opt">,</span> b<span class="hl opt">)</span>    <span class="hl slc"># b = mul3_reg + a</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;mul3_reg&quot;</span><span class="hl opt">)</span>

<span class="hl slc"># NORCPU code</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;start&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl num">0xFFFF</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;stack_reg&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;stack&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">code_label</span><span class="hl opt">(</span><span class="hl str">&quot;start&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;cmp_flag&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;exchange&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;secret_password&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span>secret_password_xor_mask<span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;cmp_flag&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl kwb">len</span><span class="hl opt">(</span>secret_password<span class="hl opt">),</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>

cmp_loop <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>cmp_loop<span class="hl opt">)</span>               <span class="hl slc"># cmp_loop:</span>
<span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>                                      <span class="hl slc"># ch = *ptr</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>                            <span class="hl slc"># ch ^= xor_mask</span>
<span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;t&quot;</span><span class="hl opt">)</span>                                      <span class="hl slc"># t = *ptr2</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;t&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>                                   <span class="hl slc"># ch = ch ^ t</span>
<span class="hl kwd">OR</span><span class="hl opt">(</span><span class="hl str">&quot;cmp_flag&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;cmp_flag&quot;</span><span class="hl opt">)</span>                       <span class="hl slc"># cmp_flag |= ch</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>                           <span class="hl slc"># ptr += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>                         <span class="hl slc"># ptr2 += 1</span>
<span class="hl kwd">MUL3</span><span class="hl opt">(</span><span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>                           <span class="hl slc"># xor_mask *= 3</span>
<span class="hl kwd">ADDi</span><span class="hl opt">(</span><span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> secret_password_add<span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>      <span class="hl slc"># xor_mask += add_const</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>                         <span class="hl slc"># i -= 1</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>cmp_loop<span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> <span class="hl str">&quot;exchange_sz&quot;</span><span class="hl opt">)</span>

ok_label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;cmp_flag&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JZi</span><span class="hl opt">(</span>ok_label<span class="hl opt">)</span>

exit_label <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">JMPi</span><span class="hl opt">(</span>exit_label<span class="hl opt">)</span>

<span class="hl kwd">code_label</span><span class="hl opt">(</span>ok_label<span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;secret_code&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;secret_code_sz&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">MOVi</span><span class="hl opt">(</span>secret_code_xor_mask<span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">MOVi</span><span class="hl opt">(</span><span class="hl str">&quot;exchange&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">MOV</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;exchange_sz&quot;</span><span class="hl opt">)</span>

loop <span class="hl opt">=</span> <span class="hl kwd">next_label</span><span class="hl opt">()</span>
<span class="hl kwd">code_label</span><span class="hl opt">(</span>loop<span class="hl opt">)</span>                   <span class="hl slc"># loop:</span>
<span class="hl kwd">PEEK</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>                             <span class="hl slc"># ch = *ptr</span>
<span class="hl kwd">XOR</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ch&quot;</span><span class="hl opt">)</span>                   <span class="hl slc"># ch ^= xor_mask</span>
<span class="hl kwd">POKE</span><span class="hl opt">(</span><span class="hl str">&quot;ch&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>                            <span class="hl slc"># *ptr2 = ch</span>
<span class="hl kwd">MUL3</span><span class="hl opt">(</span><span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span>                  <span class="hl slc"># xor_mask *= 3</span>
<span class="hl kwd">ADDi</span><span class="hl opt">(</span><span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">,</span> secret_code_add<span class="hl opt">,</span> <span class="hl str">&quot;xor_mask&quot;</span><span class="hl opt">)</span> <span class="hl slc"># xor_mask += add_const</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr&quot;</span><span class="hl opt">)</span>                  <span class="hl slc"># ptr += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ptr2&quot;</span><span class="hl opt">)</span>                <span class="hl slc"># ptr2 += 1</span>
<span class="hl kwd">ADD</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;const_minus_1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>                <span class="hl slc"># i = i - 1</span>
<span class="hl kwd">IS_0</span><span class="hl opt">(</span><span class="hl str">&quot;i&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">JNZi</span><span class="hl opt">(</span>loop<span class="hl opt">)</span>

<span class="hl kwd">code_label</span><span class="hl opt">(</span>exit_label<span class="hl opt">)</span>             <span class="hl slc"># exit_label:</span>
<span class="hl kwd">EXITi</span><span class="hl opt">(</span><span class="hl num">0x00</span><span class="hl opt">)</span>

<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">8</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;stack&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;secret_code_sz&quot;</span><span class="hl opt">,</span> <span class="hl kwb">len</span><span class="hl opt">(</span>secret_code<span class="hl opt">))</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;secret_code&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl kwb">len</span><span class="hl opt">(</span>secret_code<span class="hl opt">))</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;secret_password_sz&quot;</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;secret_password&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">16</span><span class="hl opt">)</span>

<span class="hl kwd">var</span><span class="hl opt">(</span><span class="hl str">&quot;exchange_sz&quot;</span><span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">)</span>
<span class="hl kwd">data_label</span><span class="hl opt">(</span><span class="hl str">&quot;exchange&quot;</span><span class="hl opt">)</span>
<span class="hl kwb">buffer</span><span class="hl opt">(</span><span class="hl num">32</span><span class="hl opt">)</span>

<span class="hl slc"># Compiler</span>

text <span class="hl opt">=</span> code_segment
text<span class="hl opt">.</span><span class="hl kwd">extend</span><span class="hl opt">(</span>data_segment<span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Phase 1. Calculate names.</span>

addr <span class="hl opt">=</span> <span class="hl num">0</span>
names <span class="hl opt">= {}</span>
<span class="hl kwa">for</span> line <span class="hl kwa">in</span> text<span class="hl opt">:</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">';'</span><span class="hl opt">:</span> <span class="hl kwa">continue</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] !=</span> <span class="hl str">' '</span><span class="hl opt">:</span>
    name <span class="hl opt">=</span> line<span class="hl opt">.</span><span class="hl kwd">partition</span><span class="hl opt">(</span><span class="hl str">':'</span><span class="hl opt">)[</span><span class="hl num">0</span><span class="hl opt">]</span>
    names<span class="hl opt">[</span>name<span class="hl opt">] =</span> addr
  <span class="hl kwa">else</span><span class="hl opt">:</span>
    addr <span class="hl opt">=</span> addr <span class="hl opt">+</span> <span class="hl num">1</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> names

raw_text <span class="hl opt">=</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Resolve names.</span>

<span class="hl kwa">for</span> name <span class="hl kwa">in</span> names<span class="hl opt">:</span>
  <span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
    <span class="hl kwa">print</span> name<span class="hl opt">,</span> names<span class="hl opt">[</span>name<span class="hl opt">],</span> <span class="hl kwb">type</span><span class="hl opt">(</span>names<span class="hl opt">[</span>name<span class="hl opt">])</span>
  name_re <span class="hl opt">=</span> re<span class="hl opt">.</span><span class="hl kwb">compile</span><span class="hl opt">(</span>r<span class="hl str">'dw '</span> <span class="hl opt">+</span> name <span class="hl opt">+</span> <span class="hl str">'$'</span><span class="hl opt">,</span> re<span class="hl opt">.</span>M<span class="hl opt">)</span>
  value <span class="hl opt">=</span> <span class="hl str">&quot;%d&quot;</span> <span class="hl opt">%</span> names<span class="hl opt">[</span>name<span class="hl opt">]</span>
  raw_text <span class="hl opt">=</span> name_re<span class="hl opt">.</span><span class="hl kwd">sub</span><span class="hl opt">(</span><span class="hl str">'dw '</span> <span class="hl opt">+</span> value<span class="hl opt">,</span> raw_text<span class="hl opt">)</span>

text <span class="hl opt">=</span> raw_text<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(</span><span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span>text<span class="hl opt">)</span>

<span class="hl slc"># Phase 2. Compilation.</span>

addr <span class="hl opt">=</span> <span class="hl num">0</span>
comment <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
mem <span class="hl opt">= []</span>
<span class="hl kwa">for</span> line <span class="hl kwa">in</span> text<span class="hl opt">:</span>
  <span class="hl kwa">if</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] ==</span> <span class="hl str">';'</span> <span class="hl kwa">or</span> line<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">] !=</span> <span class="hl str">' '</span><span class="hl opt">:</span>
    comment <span class="hl opt">=</span> comment <span class="hl opt">+</span> line <span class="hl opt">+</span> <span class="hl str">' '</span>
  <span class="hl kwa">else</span><span class="hl opt">:</span>
    value <span class="hl opt">=</span> <span class="hl kwb">int</span><span class="hl opt">(</span>line<span class="hl opt">.</span><span class="hl kwd">strip</span><span class="hl opt">().</span><span class="hl kwd">partition</span><span class="hl opt">(</span><span class="hl str">&quot; &quot;</span><span class="hl opt">)[</span><span class="hl num">2</span><span class="hl opt">])</span>
    <span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
      <span class="hl kwa">print</span> <span class="hl str">&quot;%04X: %04X ; %s&quot;</span> <span class="hl opt">% (</span>addr<span class="hl opt">,</span> value<span class="hl opt">,</span> comment<span class="hl opt">)</span>
    mem<span class="hl opt">.</span><span class="hl kwd">append</span><span class="hl opt">(</span>value<span class="hl opt">)</span>
    addr <span class="hl opt">=</span> addr <span class="hl opt">+</span> <span class="hl num">1</span>
    comment <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>

<span class="hl slc"># Interpretation</span>

ip <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">]</span>
exit_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">]</span>
shift_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">]</span>
carry_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;carry_reg&quot;</span><span class="hl opt">]</span>

<span class="hl kwa">def</span> <span class="hl kwd">nor</span><span class="hl opt">(</span>a<span class="hl opt">,</span> b<span class="hl opt">):</span>
  r <span class="hl opt">=</span> a | b
  r <span class="hl opt">=</span> r ^ <span class="hl num">0xFFFF</span>
  <span class="hl kwa">return</span> r <span class="hl opt">&amp;</span> <span class="hl num">0xFFFF</span>

<span class="hl kwa">def</span> <span class="hl kwd">norcpu</span><span class="hl opt">():</span>
  <span class="hl kwa">while</span> <span class="hl num">1</span><span class="hl opt">:</span>
    i <span class="hl opt">=</span> mem<span class="hl opt">[</span>ip<span class="hl opt">];</span>
    a <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">0</span><span class="hl opt">]</span>
    b <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">]</span>
    r <span class="hl opt">=</span> mem<span class="hl opt">[</span>i <span class="hl opt">+</span> <span class="hl num">2</span><span class="hl opt">]</span>
    mem<span class="hl opt">[</span>ip<span class="hl opt">] =</span> i <span class="hl opt">+</span> <span class="hl num">3</span>
    f <span class="hl opt">=</span> <span class="hl kwd">nor</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>a<span class="hl opt">],</span> mem<span class="hl opt">[</span>b<span class="hl opt">])</span>
    mem<span class="hl opt">[</span>r<span class="hl opt">] =</span> f
    mem<span class="hl opt">[</span>shift_reg<span class="hl opt">] = ((</span>f <span class="hl opt">&gt;&gt;</span> <span class="hl num">15</span><span class="hl opt">) &amp;</span> <span class="hl num">1</span><span class="hl opt">)</span> | <span class="hl opt">((</span>f <span class="hl opt">&amp;</span> <span class="hl num">0x7FFF</span><span class="hl opt">) &lt;&lt;</span> <span class="hl num">1</span><span class="hl opt">)</span>

    <span class="hl kwa">if</span> verbose_cpu<span class="hl opt">:</span>
      <span class="hl kwa">print</span> <span class="hl str">&quot;%04X: %04X [%04X] %04X [%04X] -&gt; %04X [%04X]&quot;</span> <span class="hl opt">%</span> \
            <span class="hl opt">(</span>i<span class="hl opt">,</span> a<span class="hl opt">,</span> mem<span class="hl opt">[</span>a<span class="hl opt">],</span> b<span class="hl opt">,</span> mem<span class="hl opt">[</span>b<span class="hl opt">],</span> r<span class="hl opt">,</span> mem<span class="hl opt">[</span>r<span class="hl opt">])</span>
    <span class="hl kwa">if</span> r <span class="hl opt">==</span> exit_reg<span class="hl opt">:</span>
      <span class="hl kwa">break</span>

<span class="hl kwa">print</span> <span class="hl str">&quot;Starting from [%04X]&quot;</span> <span class="hl opt">%</span> mem<span class="hl opt">[</span>ip<span class="hl opt">]</span>

<span class="hl kwd">encode_string</span><span class="hl opt">(</span>secret_code<span class="hl opt">,</span> <span class="hl str">&quot;secret_code&quot;</span><span class="hl opt">,</span> secret_code_xor_mask<span class="hl opt">,</span> secret_code_add<span class="hl opt">);</span>
<span class="hl kwd">encode_string</span><span class="hl opt">(</span>secret_password<span class="hl opt">,</span> <span class="hl str">&quot;secret_password&quot;</span><span class="hl opt">,</span> secret_password_xor_mask<span class="hl opt">,</span> secret_password_add<span class="hl opt">);</span>

mem_js <span class="hl opt">=</span> <span class="hl kwd">dump_js</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-1-before.bin&quot;</span><span class="hl opt">)</span>
mem_sz <span class="hl opt">=</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

<span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">) &gt;=</span> <span class="hl num">0x10000</span><span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Too much code (%08X, %04X)&quot;</span> <span class="hl opt">% (</span><span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">),</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">) -</span> <span class="hl num">0x10000</span><span class="hl opt">)</span>
  sys<span class="hl opt">.</span><span class="hl kwd">exit</span><span class="hl opt">()</span>

<span class="hl slc"># Inject plain password in the last moment (for testing).</span>
<span class="hl kwd">put_string</span><span class="hl opt">(</span>guess<span class="hl opt">,</span> <span class="hl str">&quot;exchange&quot;</span><span class="hl opt">)</span>

<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-2-before-with-password.bin&quot;</span><span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Original memory:&quot;</span>
  <span class="hl kwa">print</span> <span class="hl kwd">dump</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

start_time <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">()</span>

<span class="hl kwd">norcpu</span><span class="hl opt">()</span>

end_time <span class="hl opt">=</span> time<span class="hl opt">.</span><span class="hl kwd">time</span><span class="hl opt">()</span>

<span class="hl kwd">save_mem</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu-3-after.bin&quot;</span><span class="hl opt">,</span> mem_sz<span class="hl opt">)</span>

<span class="hl kwa">if</span> verbose<span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;Memory after:&quot;</span>
  <span class="hl kwd">dump</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>

<span class="hl kwa">print</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Size: %X&quot;</span> <span class="hl opt">%</span> <span class="hl kwb">len</span><span class="hl opt">(</span>mem<span class="hl opt">)</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Time: %d&quot;</span> <span class="hl opt">% (</span>end_time <span class="hl opt">-</span> start_time<span class="hl opt">)</span>
<span class="hl kwa">print</span> <span class="hl str">&quot;Exit: %04X&quot;</span> <span class="hl opt">%</span> mem<span class="hl opt">[</span>exit_reg<span class="hl opt">]</span>

exchange <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exchange&quot;</span><span class="hl opt">]</span>
result_value <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
<span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">range</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> mem<span class="hl opt">[</span>names<span class="hl opt">[</span><span class="hl str">&quot;exchange_sz&quot;</span><span class="hl opt">]]):</span>
  result_value <span class="hl opt">=</span> result_value <span class="hl opt">+</span> <span class="hl kwb">chr</span><span class="hl opt">(</span>mem<span class="hl opt">[</span>exchange <span class="hl opt">+</span> i<span class="hl opt">] &amp;</span> <span class="hl num">0xff</span><span class="hl opt">)</span>

<span class="hl kwa">print</span> <span class="hl str">&quot;Result: [%s]&quot;</span> <span class="hl opt">%</span> result_value

<span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl opt">(</span>result_value<span class="hl opt">) ==</span> <span class="hl num">0</span><span class="hl opt">:</span>
  <span class="hl kwa">print</span> <span class="hl str">&quot;ERROR: Wrong password&quot;</span>

js <span class="hl opt">=</span> string<span class="hl opt">.</span><span class="hl kwd">Template</span><span class="hl opt">(</span><span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">'template.html'</span><span class="hl opt">,</span> <span class="hl str">'r'</span><span class="hl opt">).</span><span class="hl kwd">read</span><span class="hl opt">())</span>

js <span class="hl opt">=</span> js<span class="hl opt">.</span><span class="hl kwd">substitute</span><span class="hl opt">(</span> \
  ip <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;ip&quot;</span><span class="hl opt">],</span>
  exit_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exit_reg&quot;</span><span class="hl opt">],</span>
  shift_reg <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;shift_reg&quot;</span><span class="hl opt">],</span>
  exchange <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exchange&quot;</span><span class="hl opt">],</span>
  exchange_sz <span class="hl opt">=</span> names<span class="hl opt">[</span><span class="hl str">&quot;exchange_sz&quot;</span><span class="hl opt">],</span>
  mem_js <span class="hl opt">=</span> mem_js
<span class="hl opt">)</span>

f <span class="hl opt">=</span> <span class="hl kwb">open</span><span class="hl opt">(</span><span class="hl str">&quot;norcpu2.html&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;w&quot;</span><span class="hl opt">)</span>
f<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>js<span class="hl opt">)</span>
f<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">()</span>
</pre>

</div>

<hr />


  <a href="http://easy-coding.blogspot.com/2011/02/norcpu.html"><small>Оригинальный пост</small></a> |


<a href="/about/"><small>Disclaimer</small></a>

<h1>Комментарии</h1>

<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqus_shortname = 'easy-coding';
  var disqus_developer = 0;
  var disqus_identifier = 'http://easy-coding.blogspot.com/2011/02/norcpu.html';
  var disqus_url = 'http://easy-coding.blogspot.com/2011/02/norcpu.html';
  var disqus_script = 'embed.js';
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


  </div>

  <div class="footer">
    <div class="contact">
      &copy; 2012
      <a href="mailto:alexander@demin.ws">Александр Дëмин</a> |
      <a href="/atom.xml" rel="subscribe-rss" title="Подписаться через RSS">RSS</a>
    </div>
  </div>

</div>

</body>
</html>
